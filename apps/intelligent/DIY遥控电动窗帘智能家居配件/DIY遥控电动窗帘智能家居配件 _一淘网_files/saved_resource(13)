KISSY.add("components/collect/index",function(a,b,c,d,e,f,g,h){function i(a){var b=this;i.superclass.constructor.call(b,a),b._init()}var j=b.all,k=!1,l="clickable-collect-btn",m="delete-collect-btn",n="http://ruyi.etao.com/etaouser/want",o="http://ruyi.etao.com/etaouser/is_want",p="http://ruyi.etao.com/etaouser/want?source=web&item_id=",q=d.get("_tb_token_");return a.extend(i,c,{_init:function(){e.setupConfig({xhrFields:{withCredentials:!0}});var a=this,b=new g;a.set("ivy",b),a.decideIsWanted(),a.regEvents()},getSpiderId:function(a){try{var b=decodeURIComponent(a.attr("data-spider-id"))}catch(c){b=a.attr("data-spider-id")}return b},decideIsWanted:function(){var b,c=a.one(".product-info").one(".clickable-collect-btn"),d=this;c&&(b=c.one(".collect-icon"),c.attr("data-spider-id")&&a.io({type:"get",url:o,data:{item_id:d.getSpiderId(c),csrf_token:q,allow:this.getAllow(),source:"web"},cache:!1,success:function(d){d&&(1==d.wanted&&(c.removeClass("clickable-collect-btn").addClass("delete-collect-btn").attr("title","\u53d6\u6d88\u6536\u85cf"),b.addClass("wanted"),c.parent(".collect-wrapper").addClass("wanted-collect-wrapper")),a.one(".collect-count",c)?a.one(".collect-count",c).html(d.users||0):c.append('<span class="collect-count">'+(d.users||0)+"</span>"))}}))},regEvents:function(){var b=this;j("body").delegate("mouseenter",".collect-wrapper",function(a){b.hoverWantedCollectWrapper(j(a.currentTarget),!0)}).delegate("mouseleave",".collect-wrapper",function(a){b.hoverWantedCollectWrapper(j(a.currentTarget),!1)}),j(document).delegate("click",".collect-btn",function(c){var d=a.one(c.currentTarget);"sending"!==d.attr("data-send")&&(d.attr("data-send","sending"),d.hasClass(l)?b.collect(d):b.deleteCollect(d))},b).delegate("mouseenter",".collect-btn",function(b){var c=a.one(b.currentTarget),d=c.one(".collect-icon");c.hasClass(l)?(d.addClass("wanted"),c.addClass("ivy-want-trigger")):d.addClass("wanted-hover")}).delegate("mouseleave",".collect-btn",function(b){var c=a.one(b.currentTarget),d=c.one(".collect-icon");c.hasClass(m)?d.removeClass("wanted-hover"):(d.removeClass("wanted wanted-hover"),c.removeClass("ivy-want-trigger"))})},hoverWantedCollectWrapper:function(a,b){var c=a.children(".collect-popup-outer-wrapper");a.hasClass("wanted-collect-wrapper")&&(b?c.fadeIn(.2):c.fadeOut(.2))},collect:function(b){function c(){var a=b.one(".collect-icon"),c=b.one(".collect-count");if(b.removeClass(l).addClass(m).attr("title","\u53d6\u6d88\u6536\u85cf"),a.addClass("wanted"),c){var e=parseInt(c.html(),10)+1>=0?parseInt(c.html(),10)+1:0;c.html(e)}b.parent(".collect-wrapper").addClass("wanted-collect-wrapper"),d.get("ivy").plusOne(b)}var d=this,e=new f({redirect_url:window.location.href});e.checkTrueLogin()?(c(),a.io({type:"post",url:n+"?source=web&allow="+d.getAllow(),data:{item_id:d.getSpiderId(b),csrf_token:q},success:function(a){b.attr("data-send","false"),!k&&!a.success},error:function(){b.attr("data-send","false")}})):e.show()},deleteCollect:function(b){function c(){var a,c;if(a=b.one(".collect-count"),c=b.one(".collect-icon"),b.removeClass(m).addClass(l).attr("title","\u60f3\u4e70"),a){var e=parseInt(a.html(),10)-1>=0?parseInt(a.html(),10)-1:0;a.html(e)}b.parent(".collect-wrapper").removeClass("wanted-collect-wrapper"),c.removeClass("wanted wanted-hover"),d.get("ivy").minusOne()}var d=this;c(),a.io({type:"DELETE",url:p+d.getSpiderId(b)+"&csrf_token="+q+"&allow="+d.getAllow(),success:function(a){b.attr("data-send","false"),!k&&a.success!==!0},error:function(){b.attr("data-send","false")}})},getAllow:function(){var a,b,c=0,a=window.location.href;return b=new h(a).getHostname(),-1!==b.indexOf("sandbox3.s.etao.com")?c=3:-1!==b.indexOf("rambo.s.etao.com")?c=1:-1!==b.indexOf("s.etao.com")&&(c=0),c}},{ATTRS:{ivy:{value:null}}}),i},{requires:["node","base","cookie","io","ecc/login/1.0.0/","components/ivy/","uri","./index.css"]});KISSY.add("components/ivy/index",function(a,b,c,d,e,f,g,h,i){function j(a){var b=this;j.superclass.constructor.call(b,a),b._init()}var k=b.all,l="http://ruyi.etao.com/etaouser",m=l+"/list_wanted",n=l+"/check_message",o=l+"/list_messages",p=l+"/clear_message",q=f.get("_tb_token_"),r="#J_Ivy-wrap";j.tips={UNLOGEDIN:"\u767b\u5f55\u6dd8\u5b9d\u8d26\u53f7\uff0c\u4f53\u9a8c\u964d\u4ef7\u4fe1\u606f\u63d0\u9192\u529f\u80fd\uff01",WANT_ADD_TIP:"\u5148\u6dfb\u52a0\u5546\u54c1\u5230\u60f3\u4e70\uff0c\u624d\u4f1a\u6709\u964d\u4ef7\u6d88\u606f",NO_PRICE_REDUCTION_MESSAGE:"\u6682\u65e0\u964d\u4ef7\u6d88\u606f",PRICE_REDUCTION_MESSAGE:"\u964d\u4ef7\u6d88\u606f",PRICE_REDUCTION_SUMMARY_HTML:['<div class="ivy-total-price-reduction-count">',"{{#history}}","    \u5386\u53f2\u5171\u6709<span>{{count}}</span>\u6b21\u964d\u4ef7</div>","{{/history}}","{{^history}}","    \u4eb2\uff0c\u4f60\u6709<span>{{count}}</span>\u6b21\u65b0\u964d\u4ef7</div>","{{/history}}",'<div class="ivy-reduction-price-amount">',"    \u5171\u8ba1<span>\uffe5{{savedMoney}}</span>","</div>"].join("")},j.templates={body:['    <div id="J_Tip">',"    </div>",'<div id="ivy-want-flag" class="ivy-want-icon"></div>','<div id="ivy-want-wrap" class="collect">','    <span class="icon ivy-want-icon"></span>','    <span id="ivy-want-count-wrap">',"        <span>\u60f3\u4e70</span>",'        <span id="ivy-want-count">0</span>',"    </span>",'    <a data-stat="'+window.clickStat+'&lf_aclog=null-null-null-null-0&stats_click=detail_reduce%3Aallfavorite" id="ivy-want-check-all" href="http://i.etao.com/favorite/collect_list.html" target="_blank">',"        <span>\u67e5\u770b\u5168\u90e8</span>","    </a>","</div>",'<div id="ivy-price-alert-wrap">','    <div id="ivy-price-alert-info-bar" class="icon notice" >','        <a data-stat="'+window.clickStat+'&lf_aclog=null-null-null-null-0&stats_click=srp_jjfc_all%3A1" id="ivy-price-alert-check-all"  href="http://i.etao.com/favorite/collect_price_reduction.html?spm=0.0.0.0.QzDzi9" target="_blank">',"            <span>\u67e5\u770b\u5168\u90e8</span>",'            <span class="ivy-check-all white-check icon"></span>',"        </a>",'        <a class="clearfix" id="ivy-tip-wrap" href="#"></a>',"    </div>",'    <div id="ivy-price-alert-expand-tip" class="notice">','        <span class="icon"></span>',"    </div>",'    <div id="ivy-price-alert-content" >','        <div id="ivy-no-want-commodity-tip">','            <span class="ivy-warning-icon icon"></span>',"            <p>\u554a\u54e6\uff01\u76ee\u524d\u8fd8\u6ca1\u6709\u60f3\u4e70\u7684\u5546\u54c1</p>","            <p>\u8bf7\u5148\u70b9\u51fb\u5546\u54c1\u56fe\u7247\u4e0a\u7684\u60f3\u4e70\u6309\u94ae</p>","            <p>\u6dfb\u52a0\u5546\u54c1\u5230\u60f3\u4e70\uff0c\u4e4b\u540e\u5c31\u6709\u964d\u4ef7\u6d88\u606f\u5566\uff01</p>","        </div>",'        <div id="ivy-no-price-alert-commodity-tip">','            <span class="ivy-warning-icon icon"></span>',"            <p>\u4eb2\uff0c\u4f60\u7684\u60f3\u4e70\u4e2d\u76ee\u524d\u8fd8\u6ca1\u6709\u964d\u4ef7\u7684\u5546\u54c1</p>","            <p>\u4f46\u4f60\u53ef\u4ee5\u53bb",'                <a data-stat="'+window.clickStat+'&lf_aclog=null-null-null-null-0&stats_click=detail_reduce%3Amorefavorite" class="ivy-want-link" href="http://i.etao.com/favorite/collect_list.html" target="_blank">\u67e5\u770b\u5168\u90e8\u60f3\u4e70\u7684\u5546\u54c1</a>',"            </p>","        </div>",'        <div id="ivy-price-alert-info-wrap">','            <div id="ivy-price-alert-info-header">','                <div class="ivy-total-price-reduction-count">',"                    \u6709<span>0</span>\u6b21\u65b0\u7684\u964d\u4ef7","                </div>",'                <div class="ivy-reduction-price-amount">\u5171\u8ba1',"                    <span>\uffe50</span>","                </div>","            </div>",'            <ul id="ivy-price-alert-list"></ul>',"        </div>","    </div>","</div>"].join(""),MESSAGES:["{{#items}}",'   <li class="ivy-price-alert-commodity-item">','       <a data-stat="{{datastat}}" class="ivy-price-alert-commodity-item-link" href="{{link}}" target="_blank">','           <div class="ivy-price-alert-commodity-image">','               <img src="{{small_image}}">',"           </div>",'           <div class="ivy-price-alert-commodity-info">','               <div class="ivy-price-alert-commodity-title">{{title}}</div>','               <div class="ivy-price-alert-commodity-reduction-price">\u964d\u4e86',"                   <span>\uffe5{{reduction_price}}</span>","               </div>","           </div>","         </a>","   </li>","{{/items}}"].join(""),favour:['<div class="tip {{#if favorType===1}}no-rebate{{/if}}">','    <div class="close-wrap">','        <i class="iconfont_10 close">&#983219</i>',"    </div>",'    <div class="connect">','        <div class="iconfont_10 monitor">&#983185</div>','        <div class="iconfont_10 plus">&#983413</div>','        <div class="iconfont_10 phone">&#983202</div>',"    </div>",'    <p class="already">\u5df2\u540c\u6b65\u6536\u85cf</p>',"    {{^if ucUrl}}","        {{#if favorType===2}}","        {{else}}",'            <p class="detail" >\u624b\u673a\u8d2d\u4e70\u4f18\u60e0\u66f4\u591a</p>',"        {{/if}}","     {{/if}}","</div>"].join("")},j.statusType={UNLOGEDIN:"unlogedin",NO_WANTS:"no-wants",NO_PRICE_ALERT_COMMODITY:"no-price-alert-commodity",PRICE_ALERT_MESSAGE:"price-alert-message"},j.expandType={SHRINK:"shrink",EXPAND:"expand"},j.status={unlogedin:j.tips.UNLOGEDIN,"no-wants":{shrink:j.tips.WANT_ADD_TIP,expand:j.tips.NO_PRICE_REDUCTION_MESSAGE},"no-price-alert-commodity":j.tips.NO_PRICE_REDUCTION_MESSAGE,"price-alert-message":{shrink:function(b){var c=parseInt(b.count);return c>999&&(c="999+"),a.one("#ivy-price-alert-check-all").hide(),new h(j.tips.PRICE_REDUCTION_SUMMARY_HTML).render(b)},expand:function(){return a.one("#ivy-price-alert-check-all").show(),"<span>"+j.tips.PRICE_REDUCTION_MESSAGE+"</span>"}}},j.currentStatus="",j.currentPriceAlertSummary={history:!1,count:0,savedMoney:0},j.MESSAGE_CHECK_INTERVAL=6e4,j.hasNewPriceAlertMessage=!1,j.newPriceAlertMessageReaded=!1;var s,t=!1;return j.render=function(){var b=j.templates.body;a.all('<div id="J_Ivy-wrap" class="ivy-wrap"></div>').insertBefore("#etao-footer"),a.one(r).append(b)},a.extend(j,c,{_init:function(){var b=this;j.render();var c=new d({redirect_url:window.location.href});if(b.set("login",c),!c.checkLongOrTrueLogin()){var e=window.clickStat+"lf_aclog=null-null-null-null-0&stats_click=srp_jjfc_login%3A1";a.one("#ivy-tip-wrap").attr("data-stat",e)}c.checkLongOrTrueLogin()?b.init():b.updateStatus(j.statusType.UNLOGEDIN),6===a.UA.ie&&b.fixIE6(),b._myInit();var f="/tongji",g="etao_search",h="f_stats_show=detail_reduce:1",i="H51884970"},_myInit:function(){var a=this;a.set("container",r),a._bind()},_bind:function(){var b=this,c=b.get("container");c.delegate("click",".close",function(){b._closeTip()}),k("body").delegate("mouseenter","#ivy-want-wrap",function(){a.one(r).hasClass("no-wants")||(a.one("#ivy-want-count-wrap").hide(),a.one("#ivy-want-check-all").show())}).delegate("mouseleave","#ivy-want-wrap",function(){a.one("#ivy-want-count-wrap").show(),a.one("#ivy-want-check-all").hide()}),k("body").delegate("mouseenter",".notice",function(){t=!0,clearTimeout(s),a.one("#ivy-price-alert-expand-tip").addClass("ivy-info-bar-hover")}).delegate("mouseleave",".notice",function(){t=!1,s=setTimeout(function(){a.one("#ivy-price-alert-expand-tip").removeClass("ivy-info-bar-hover")},0)}).delegate("click",".notice",function(a){var c=b.get("login");a.stopPropagation(),c.checkLongOrTrueLogin()?b.togglePriceAlertBarClick():c.show()}),k("body").delegate("mouseenter","#ivy-price-alert-content",function(){t=!0}).delegate("mouseleave","#ivy-price-alert-content",function(){t=!1})},init:function(){var b=this;b.checkWantProducts(function(a){a?b.renderNewPriceAlertMessages(function(a){a||b.renderPriceAlertHistory()}):b.updateStatus(j.statusType.NO_WANTS,j.expandType.SHRINK),b.updateWantCount(a)}),a.one(document.body).on("click",function(c){a.one(c.currentTarget);a.one("#ivy-price-alert-wrap").hasClass("ivy-content-visible")&&(t||b.togglePriceAlertBarClick())}),setInterval(function(){b.renderNewPriceAlertMessages()},j.MESSAGE_CHECK_INTERVAL)},updateStatus:function(b,c,d){if(j.status.hasOwnProperty(b)){j.currentStatus=b;var e=j.status[b],f=a.one(r),g=a.one("#ivy-tip-wrap");if("object"==typeof e){if(c&&e[c]){var h=e[c];"string"==typeof h?e="<span>"+h+"</span>":"function"==typeof h&&(e=h(d))}}else e="<span>"+e+"</span>";g.html(e),f[0].className=b}},plusOne:function(b){var c=this,d=a.one("#ivy-want-count").text();d=parseInt(d)+1,this.runCollectionAnimate(b,function(){c.runPlusOneAnimate()}),b.one(".collect-count")?(c.renderFavour(),c._animateTip()):c._closeTip(),this.updateWantStatus(d)},_animateTip:function(){var b,c=this,d=c.get("container").one(".tip");b=d.hasClass("no-rebate")?"-97px":"-116px",d.animate({top:b},{queue:"plus",duration:1,easing:"easeIn",complete:function(){setTimeout(a.bind(c._closeTip,c),5e3)}})},minusOne:function(){var b=a.one("#ivy-want-count").text();b=parseInt(b)-1,this.updateWantStatus(b)},updateWantCount:function(b){b=parseInt(b),(!b||0>b)&&(b=0),b>9999&&(b="9999+"),a.one("#ivy-want-count").text(b)},updateWantStatus:function(a){var b=this;j.currentStatus==j.statusType.NO_WANTS?a>0&&this.renderNewPriceAlertMessages(function(a){a||b.updateStatus(j.statusType.NO_PRICE_ALERT_COMMODITY)}):0>=a&&this.updateStatus(j.statusType.NO_WANTS,j.expandType.SHRINK),this.updateWantCount(a)},runPlusOneAnimate:function(){var b=a.DOM.create('<div class="ivy-plus-one">+1</div>');a.one(r).append(b),b=a.one(b),b.css({top:0,opacity:1}),b.animate({top:"-12px"},{queue:"plus",duration:.3}).animate({top:"-22px",opacity:0},{queue:"plus",duration:.5,easing:"easeOut",complete:function(){b.remove()}})},runCollectionAnimate:function(b,c){var d=a.DOM.create('<div class="ivy-add-to-want-flag ivy-want-icon"></div>'),e=a.one("#ivy-want-wrap"),f=b.offset(),g=e.offset();g.left=g.left+57,a.one(document.body).append(d),d=a.one(d),d.show().css(f),d.animate(g,{duration:.8,easing:"easeOut",complete:function(){d.remove(),"function"==typeof c&&c()}})},renderPriceAlertHeader:function(b){var c=new h(j.tips.PRICE_REDUCTION_SUMMARY_HTML).render(b);a.one("#ivy-price-alert-info-header").html(c)},renderPriceAlertList:function(b){if(b.length){b=b.slice(0,5),a.each(b,function(a){a.small_image=a.small_image.replace("200x200","60x60"),a.nid&&(a.link="http://s.etao.com/detail/"+a.nid+".html"),a.datastat=window.clickStat+"&lf_aclog=null-null-null-null-0&stats_click=srp_jjfc_goods%3A1"});var c=new h(j.templates.MESSAGES).render({items:b});a.one("#ivy-price-alert-list").html(c)}},renderNewPriceAlertMessages:function(b){var c=this;this.checkUnreadMessages(function(d){var e,f=d.count,g=d.save_amount;if(f&&g){a.one("#ivy-price-alert-info-bar").addClass(".new-alert"),e=j.hasNewPriceAlertMessage=!0,g=parseFloat(g).toFixed(2),c.renderPriceAlertList(d.messages);var h=j.currentPriceAlertSummary={history:!1,count:f,savedMoney:g};c.renderPriceAlertHeader(h),c.updateStatus(j.statusType.PRICE_ALERT_MESSAGE,j.expandType.SHRINK,h),a.one("#ivy-price-alert-wrap").hasClass("ivy-content-visible")&&(c.setPriceAlertContentPosition(!0),j.newPriceAlertMessageReaded=!0)}else e=j.hasNewPriceAlertMessage=!1;"function"==typeof b&&b(e)})},renderPriceAlertHistory:function(b){var c=this;this.getPriceMindMessages(function(d){var e=d.save_money;if(d.total_results&&e&&d.items.length){e=parseFloat(e).toFixed(2),c.renderPriceAlertList(d.items);var f=j.currentPriceAlertSummary={history:!0,count:d.total_results,savedMoney:e};c.renderPriceAlertHeader(f),c.updateStatus(j.statusType.PRICE_ALERT_MESSAGE,j.expandType.SHRINK,f),a.one("#ivy-price-alert-wrap").hasClass("ivy-content-visible")&&c.setPriceAlertContentPosition(!0)}else c.updateStatus(j.statusType.NO_PRICE_ALERT_COMMODITY);"function"==typeof b&&b()})},setPriceAlertContentPosition:function(b){var c=a.one("#ivy-price-alert-content"),d=3;if(b){var e=c.outerHeight();d=d+1-e}c.css("top",d+"px")},togglePriceAlertBarClick:function(){var b=a.one("#ivy-price-alert-wrap"),c="ivy-content-visible",d=b.hasClass(c),e=!0,f="addClass";if(d?(e=!1,f="removeClass",j.newPriceAlertMessageReaded&&this.renderPriceAlertHistory(function(){j.newPriceAlertMessageReaded=!1})):j.hasNewPriceAlertMessage&&(j.newPriceAlertMessageReaded=!0,j.hasNewPriceAlertMessage=!1,this.clearUnreadPriceMindMessages(function(){})),6==a.UA.ie){var g=a.one("#ivy-price-alert-content");e?g.show():g.hide()}b[f](c),this.setPriceAlertContentPosition(e);var h=d?j.expandType.SHRINK:j.expandType.EXPAND;this.updateStatus(j.currentStatus,h,j.currentPriceAlertSummary)},checkWantProducts:function(b){var c=this;a.IO({type:"GET",url:m,data:{csrf_token:q,allow:c.getAllow(),source:"web"},success:function(a){b(a.total_results?a.total_results:0)}})},checkUnreadMessages:function(b){var c=this;a.IO({type:"GET",url:n,data:{csrf_token:q,allow:c.getAllow(),source:"web"},success:b})},getPriceMindMessages:function(b){var c=this;a.IO({type:"GET",url:o+"?n=5",data:{n:5,csrf_token:q,allow:c.getAllow(),source:"web"},success:b})},clearUnreadPriceMindMessages:function(b){var c=this;a.IO({type:"GET",url:p,data:{csrf_token:q,allow:c.getAllow(),source:"web"},success:b})},fixIE6:function(){var b=this,c=null,d=a.one(r);a.one(window).on("scroll",function(){clearTimeout(c),d.hide(),c=setTimeout(function(){b.resetWrapPosition(),d.show()},100)}).on("resize",function(){b.resetWrapPosition()}),this.resetWrapPosition(),a.one("#ivy-want-check-all").hide()},resetWrapPosition:function(){var b=a.one(r),c=a.DOM.scrollTop(),d=a.DOM.viewportHeight(),e=j.currentStatus==j.statusType.UNLOGEDIN?27:31;b.css("top",c+d-e)},_closeTip:function(){var a=this.get("container").one(".tip");a&&a.animate({top:"28px"},{queue:"plus",duration:.3,easing:"easeOut"})},renderFavour:function(){var b=this,c=j.templates.favour,d=window.mobileInfo;d=d||{favorType:1,moreRebate:20},d.ucUrl=b._hasUcUrl(),html=new h(c).render(d),a.one("#J_Tip").html(html)},_hasUcUrl:function(){var a,b,c=location.href;return a=new i(c),b=a.getQuery().get("uc_url"),void 0!==b},getAllow:function(){var a,b,c=0,a=window.location.href;return b=new i(a).getHostname(),-1!==b.indexOf("sandbox3.s.etao.com")?c=3:-1!==b.indexOf("rambo.s.etao.com")?c=1:-1!==b.indexOf("s.etao.com")&&(c=0),c}},{ATTRS:{container:{value:null,setter:function(c){return c instanceof a.NodeList?c:b.one(c)}},login:{value:null}}}),j},{requires:["node","base","ecc/login/1.0.0/","io","cookie","anim","xtemplate","uri","./index.css"]});