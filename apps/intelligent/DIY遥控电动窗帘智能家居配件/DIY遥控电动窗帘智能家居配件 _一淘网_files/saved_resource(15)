KISSY.add("components/mobile-buy/index",function(a,b,c,d,e,f,g){function h(a){var b=this;h.superclass.constructor.call(b,a),b._init()}var i=b.one,j="#mobile-buy",k="#J_product-pic";return a.extend(h,c,{_init:function(){var a=this;a._bind(),a._initOverlay(),a.set("picContainer",k)},_bind:function(){var b=this,c=i("#mobile-buy");c&&(window.globalEvent.on("discountMobileClick",function(){b.set("buyHalt",!0),a.one("#mobile-buy").fire("click")}),c.on("click",b._mobileBuy,b))},_initOverlay:function(){var b,c=this,f=c.get("closable"),g=c.get("mask");b=new e({align:{points:["cc","cc"]},elCls:"ok-mobile-popup",elStyle:{position:a.UA.ie<7?"absolute":"fixed"},width:511,closable:f,mask:g}),b.on("show",function(){this.center()}),b.on("hide",function(){this.get("contentEl").html("")}),d.on(window,"scroll resize",a.buffer(function(){b.center()},100)),b.render(),b.hide(),c.set("popup",b)},_bindPop:function(){var a=this;d.delegate(document,"click",".ok-mobile-close",a._closePopup,a),d.delegate(document,"click",".ok-mobile-retry",a._tryAgain,a),d.on(document,"keydown",a._keydown,a)},_closePopup:function(){popup=this.get("popup"),popup&&popup.hide()},_tryAgain:function(){this._closePopup(),a.later(function(){d.fire(j,"click")},50)},_keydown:function(a){27===a.keyCode&&this._closePopup()},_mobileBuy:function(b){var c=this,d=c.get("isBind"),e=i(b.target),f=e.attr("data-url");b.preventDefault(),c.get("buyHalt")&&(b.halt(),c.set("buyHalt",!1)),d||(c.set("isBind",!0),c._bindPop()),c._checkLogin(function(){a.io({url:f,type:"GET",dataType:"jsonp",cache:!1,success:function(a){a.success?(0==a.result||-1==a.result)&&c._showPopup(!0):c._showPopup(!1)}})},c)},_checkLogin:function(a,b){var c=new f({needRefresh:!1,redirect_url:"http://s.etao.com/login.htm"});c.checkLongOrTrueLogin()?a.call(b):(c.show({full_redirect:!0}),window.ETao.loginSuccess=function(){try{c.hide()}catch(a){var b=i(".etaologin-overlay-mask"),e=i(".etaologin-overlay");b&&b.remove(),e&&e.remove()}new ETao.Header,d.fire(j,"click")})},_showPopup:function(a){var b,c=this,d=c.get("popup"),e=d.get("contentEl");e.css("height",350),d.loading(),d.show(),a?(c._renderSuccess(),c._animate(e)):(b=c.get("failTpl"),e.html(b)),e.css("height","auto"),d.center(),d.unloading()},_renderSuccess:function(){var a,b=this,c=b.get("popup"),d=c.get("contentEl"),e=b.get("successTpl"),f=window.clickStat,h=window.mobileInfo,i=null,j="";f+="&lf_aclog=null-null-null-null-0&stats_click=detail_main%3Aphoneok",a=h&&h.moreRebate,i=a&&0!=h.favorType?{moreRebate:a,stat:f}:{stat:f},j=new g(e).render(i),d.html(j)},_animate:function(b){var c,d=this,e=d.get("curImg"),f=e.offset(),g=b.one(".ok-mobile-msg"),h=g.offset();c=i("<img>").attr({src:e.attr("src"),width:155,height:155}).appendTo("body"),c.css({position:"absolute",zIndex:10001,overflow:"hidden",left:f.left+77,top:f.top+77}),c.animate({left:h.left+60,top:h.top+30},.3,"easeIn",function(){c.animate({left:h.left+201,top:h.top+216,width:0,height:0},.5,"easeOut",function(){a.later(function(){c.remove(),g.all(".png").attr({src:g.all(".gif").attr("src")}),d._easeIn()},300)})})},_easeIn:function(){var b=this,c=a.one("#J_ok-tip");a.later(function(){c.fadeIn(1)},1300),a.later(function(){b._renderCodeImg()},1300)},_renderCodeImg:function(){var b=a.one(j),c=b&&b.attr("data-imgurl");c&&a.use("gallery/qrcode/1.0/",function(a,b){new b("J_ok-img-code",{text:c,width:120,height:120,correctLevel:b.CorrectLevel.L}),a.one("#J_ok-img-code").css("background","transparent")})}},{ATTRS:{isBind:{value:!1},btn:{value:null,setter:function(b){return b instanceof a.NodeList?b:i(b)}},picContainer:{value:null,setter:function(b){return b instanceof a.NodeList?b:i(b)}},curImg:{value:null,getter:function(){var a=this.get("picContainer");return a.one(".active").one("img")}},closable:{value:!0},mask:{value:!0},popup:{value:null},successTpl:{value:['<div class="ok-mobile-msg">','<div class="dis">','<img class="png" width="511" height="463" src="http://gtms01.alicdn.com/tps/i1/T18YcGXaNfXXXylFjS-511-463.png" alt="\u7a7f\u8d8a\u6210\u529f"/>','<img style="display:none;" class="gif" width="511" height="463" src="http://gtms02.alicdn.com/tps/i2/T1MEyrFpJgXXXnipjS-511-463.gif" alt="\u6210\u529f\u52a8\u753b"/>','<div id="J_ok-tip" class="ok-tip" style="display:none;">','<div id="J_ok-img-code" class="ok-img-code"></div>',"{{#moreRebate}}",'<p class="setup">\u672a\u5b89\u88c5\u4e00\u6dd8\u5ba2\u6237\u7aef\uff0c\u8bf7\u5148\u626b\u7801\u5b89\u88c5</p>',"{{/moreRebate}}","{{^moreRebate}}",'<p class="more">\u626b\u7801\u67e5\u770b\u66f4\u591a\u4f18\u60e0</p>',"{{/moreRebate}}","</div>","</div>",'<a class="ok-mobile-sure ok-mobile-close" data-stat="{{stat}}" href="javascript:void(0);">\u77e5\u9053\u4e86</a>'].join("")},failTpl:{value:['<div class="ok-mobile-msg">','<div class="war">','<i class="iconfont">&#227</i>','<div class="hd">\u62b1\u6b49\uff0c\u672c\u6b21\u7a7f\u8d8a\u4e0d\u6210\u529f\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5','<div class="sub">\u60a8\u4e5f\u53ef\u4ee5\u9009\u62e9\u76f4\u63a5\u626b\u7801\u8d2d\u4e70</div>',"</div>","</div>","</div>",'<a class="ok-mobile-retry" href="javascript:void(0);">\u518d\u6b21\u7a7f\u8d8a</a>','<a class="ok-mobile-cancel ok-mobile-close" href="javascript:void(0);">\u53d6\u6d88</a>'].join("")}}}),h},{requires:["node","base","event","overlay","etaologin","xtemplate","./index.css"]});