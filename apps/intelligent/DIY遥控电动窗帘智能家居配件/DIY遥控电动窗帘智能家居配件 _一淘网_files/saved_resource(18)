KISSY.add("components/product-info/index",function(a,b,c,d,e,f,g){function h(a){var b=this;h.superclass.constructor.call(b,a),b._init()}var i=b.all;return a.extend(h,c,{_init:function(){var a=this,b=a.get("el");window.login||(window.login=new e({needRefresh:!1,redirect_url:"http://"+document.location.host+"/login.htm"}));var c,d=b.attr("nid"),g=b.attr("skuProperties"),h=b.attr("dpp");c=a.get("planIndex")?a.get("planIndex"):0,window.login.checkLongOrTrueLogin()&&f.purchaseDetail(d,function(b){b&&b.success&&b.result&&b.result.allPlans&&a.set("curFavorInfo",b.result)},partner,g,h),i(".rebate-con")&&a._regSpeedHover(),b.one(".quan-cnt")&&(a._regQuanEvent(),a._regCouponEvent()),b.delegate("click",".login-btn",function(){var a=new e({needRefresh:!0});a.show()}),b.delegate("click",".to-comment",function(a){a.preventDefault(),i("#nav-comment").fire("click"),i("#J_tab").scrollIntoView()}),b.delegate("click",".bubble-close",function(a){a.preventDefault();var b=i(a.currentTarget),c=b.parent(".bubble-product");c&&c.remove()})},_renderBox:function(b){var c="7\u67081\u65e5\u540e\uff0c\u4e00\u6dd8\u94fe\u63a5\u641c\u7d22\u4e1a\u52a1\u5c06\u505c\u6b62\u8fd4\u5229\u3002";2==b&&(c="\u4e00\u6dd8\u94fe\u63a5\u641c\u7d22\u4e1a\u52a1\u5df2\u7ecf\u505c\u6b62\u8fd4\u5229\u3002");var d={content:'<div class="norebate-alert"><div class="title"></div>'+c+'<br/>\u5bf9\u60a8\u9020\u6210\u7684\u4e0d\u4fbf\u6211\u4eec\u6df1\u8868\u6b49\u610f\u3002<div class="btn-center"><button id="norebate-alert-close">\u6211\u77e5\u9053\u4e86</button></div></div>',align:{points:["cc","cc"]},elStyle:{position:a.UA.ie<7?"absolute":"fixed"},width:413,height:266,mask:!0},e=new g(d);e.render(),e.show(),KISSY.one("#norebate-alert-close").on("click",function(){e.hide()})},_regSpeedHover:function(){i(".rebate-con").on("mouseenter",function(a){i(a.currentTarget).addClass("rebate-hover")}).on("mouseleave",function(a){i(a.currentTarget).removeClass("rebate-hover")})},_regCouponEvent:function(){var a=this,b=a.get("el");b.delegate("click",".quan-tip",function(c){var d=i(c.currentTarget),e=d.parent(".quan-panel");if(!d.hasClass("quan-tip-cur")){i(".quan-tip-cur").removeClass("quan-tip-cur"),i(".coupon-selected-icon").remove(),d.addClass("quan-tip-cur"),d.append('<s class="coupon-selected-icon"></s>'),e.one(".quan-title .des").html(d.one(".des").html());var f=parseInt(d.attr("quan-id"));a.set("planIndex",f);var g=window.allPlan;if(g){var h=(g[f],window.globalEvent);h&&h.fire("quanChange",{index:f})}var j=b.one(".quan-action");j&&("\u4e0d\u4f7f\u7528\u4f18\u60e0\u5238"==d.one(".des").html()?j.addClass("hidden"):j.removeClass("hidden"),a.get("quanActionList")&&a.get("quanActionList")[f]&&!j.hasClass("quan-action-finish")?(j.addClass("quan-action-finish"),j.html("\u5df2\u9886\u53d6")):j.hasClass("quan-action-finish")&&(j.removeClass("quan-action-finish"),j.html("\u70b9\u51fb\u9886\u53d6")))}return e.removeClass("quan-btn-active"),!1})},_regQuanEvent:function(){var b=this,c=b.get("el");c.delegate("click",".quan-panel",function(a){a.preventDefault();var c=i(a.currentTarget);return c.hasClass("quan-btn-active")?void c.removeClass("quan-btn-active"):(b._setQuanCntWidth(),void c.addClass("quan-btn-active"))}).delegate("mouseleave",".quan-panel",function(a){var b=i(a.currentTarget);b.removeClass("quan-btn-active")}),c.delegate("click",".quan-action",function(d){d.preventDefault();var e=i(d.currentTarget);if(!e.hasClass("quan-action-finish")){var g;g=b.get("planIndex")?b.get("planIndex"):0;var h=c.attr("nid"),j=c.attr("skuProperties"),k=c.attr("dpp");window.login.checkLongOrTrueLogin()?b.get("curFavorInfo")?b._quanAction(b.get("curFavorInfo"),g,e):f.purchaseDetail(h,function(a){a&&a.success&&a.result&&a.result.allPlans?(b.set("curFavorInfo",a.result),b._quanAction(a.result,g,e)):b._failToQuanAuction()},partner,j,k):(login.show(),window.ETao.loginSuccess=function(){login.hide();var b=a.all(".etaologin-overlay-mask"),c=a.all(".etaologin-overlay");b&&!b.hasClass("etaologin-popup-mask-hidden")&&b.addClass("etaologin-popup-mask-hidden").addClass(" etaologin-overlay-mask-hidden"),c&&!c.hasClass("etaologin-popup-hidden")&&c.addClass("etaologin-popup-hidden").addClass("etaologin-overlay-hidden"),new ETao.Header,e.fire("click")})}})},_quanAction:function(b,c,d){var e=this,f="";a.Cookie.get("_tb_token_")&&(f=a.Cookie.get("_tb_token_"));var g="http://quan.etao.com/ajax/claim.htm?id="+b.allPlans[c].quanId+"&source="+b.allPlans[c].quanSource+"&sid="+b.auction.sellerId+"&_tb_token_="+f+"&channel='etaodetailquan'";a.use("io",function(){a.io({url:g,type:"GET",dataType:"jsonp",complete:function(a){if(a.success&&a.data&&(0==a.data.errorCode||3==a.data.errorCode)){d.addClass("quan-action-finish"),d.html("\u5df2\u9886\u53d6");var b=e.get("quanActionList");b?(b[c]=!0,e.set("quanActionList",b)):(b=new Array,b[c]=!0,e.set("quanActionList",b))}else e._failToQuanAuction()}})})},_failToQuanAuction:function(){var b=this,c=b.get("el"),d=c.one(".quan-action"),e=d.offset().top,f=KISSY.one(window).scrollTop(),g=e-f,h='<span class="iconfont_10">&#983374</span>\u9886\u53d6\u5931\u8d25';a.use("overlay",function(a,b){var c={content:h,align:{points:["tc","tc"],offset:[0,g-69]},elCls:"quan-action-fail",closable:!0,width:130,mask:!1},d=new b(c);d.render(),d.show()})},_setQuanCntWidth:function(){for(var a=this,b=a.get("el"),c=b.one(".quan-cnt"),d=287,e=b.one(".quan-title").outerWidth(),f=0,g=i(".quan-item",c),h=0,j=g.length;j>h;h++)f+=i(g[h]).outerWidth()+5;f+=5,c.width(e>f?e:f>d?d:f)},_regBuyEvent:function(){var b=this,c=b.get("el");window.globalEvent.on("discountBuyClick",function(){b.set("buyHalt",!0),a.one("#discount-buy").fire("click")}),c.delegate("click","#discount-buy",function(d){b.get("buyHalt")&&(d.halt(),b.set("buyHalt",!1));var g,h=i(d.currentTarget),j=new e({needRefresh:!1,redirect_url:"http://"+document.location.host+"/login.htm"}),k=c.attr("nid");g=b.get("planIndex")?b.get("planIndex"):0;var l,m=({order:window.clickStat+"&lf_aclog=100-"+k+"-null-null-0&stats_click=detail_main%3Ayhgok",close:window.clickStat+"&lf_aclog=null-null-null-null-0&stats_click=detail_main%3Ayhgoff"},window.purchase_decision.query.partner),n=c.attr("skuProperties"),o=c.attr("dpp");if(j.checkLongOrTrueLogin()){var p=b.get("curFavorInfo");p?h.attr("href")||(h.attr("href",p.allPlans[g].etaoShopLink),i("#top-bar .t-discount-buy").attr("href",p.allPlans[g].etaoShopLink)):d.preventDefault()}else d.preventDefault(),j.show(),window.ETao.loginSuccess=function(){j.hide();var c=a.all(".etaologin-overlay-mask"),d=a.all(".etaologin-overlay");c&&!c.hasClass("etaologin-popup-mask-hidden")&&c.addClass("etaologin-popup-mask-hidden").addClass(" etaologin-overlay-mask-hidden"),d&&!d.hasClass("etaologin-popup-hidden")&&d.addClass("etaologin-popup-hidden").addClass("etaologin-overlay-hidden"),new ETao.Header,f.purchaseDetail(k,function(c){c&&c.success&&c.result&&c.result.allPlans&&(l=c.result.allPlans[g].etaoShopLink,h.attr("href",l),i("#top-bar .t-discount-buy").attr("href",l),b.set("curFavorInfo",c.result),b.set("planIndex",g),a.use("overlay",function(a,b){var c={content:'<div class="login-success">\u4eb2\uff0c\u60a8\u5df2\u767b\u5f55\u6210\u529f\uff01</div><a class="go-buy" data-stat="'+window.clickStat+'&lf_aclog=null-null-null-null-0&stats_click=detail_main%3Ayhgok" href="'+l+'" target="_blank">\u53bb\u5546\u5bb6\u8d2d\u4e70</a>',align:{points:["cc","cc"]},elCls:"buy-login-popup",elStyle:{position:a.UA.ie<7?"absolute":"fixed"},closable:!0,closeAction:"destory",width:340,mask:!0},d=new b(c);d.render(),d.show()}))},m,n,o)}})},_renderTips:function(a){var b=this,c=b.get("el");c.one(".real-price-num").html(a["final"]),c.one(".original-price").html(a.price);var d=c.one(".yhq");d.one(".num").html(a.coupon.saving);var e=c.one(".jfb");e&&(a.rebate?(e.one(".num").html(a.rebate.saving),e.one(".tip").html(a.rebate.desc)):(e.one(".num").html("0.00"),e.one(".tip").html("\u6682\u65e0"),e.one(".tip").removeClass("tip-info")));var f=c.one(".cx");f&&(a.activity?(f.one(".num").html(a.activity.saving),f.one(".tip").html(a.activity.desc)):(f.one(".num").html("0.00"),f.one(".tip").html("\u6682\u65e0"),f.one(".tip").removeClass("tip-info")));var g=c.one(".xrs");g&&(a.newcomer?(g.one(".num").html(a.newcomer.saving),g.one(".tip").html(a.newcomer.desc)):(g.one(".num").html("0.00"),g.one(".tip").html("\u6682\u65e0"),g.one(".tip").removeClass("tip-info")));var h=c.one(".yts");h&&(a.present?(g.one(".num").html(a.rebate.saving),g.one(".tip").html(a.rebate.desc)):(g.one(".num").html("0.00"),g.one(".tip").html("\u6682\u65e0"),g.one(".tip").removeClass("tip-info")))}},{ATTRS:{el:{value:i(".product-info")},curDialogInfo:{value:null}}}),h},{requires:["node","base","event","ecc/login/1.0.0/","components/discount/","overlay","./index.css"]});KISSY.add("components/discount/index",function(a){window.purchase_decision||(window.purchase_decision={batch_purchase_decision_url:"http://ok.etao.com/api/batch_purchase_decision.do",purchase_decision_url:"http://ok.etao.com/api/purchase_decision.do",purchase_detail_url:"http://ok.etao.com/api/purchase_detail.do",query:{src:"auction_detail",partner:"2004"}});var b={purchaseDecision:function(b,c,d,e){var f=window.purchase_decision,g=f.purchase_decision_url,h=a.clone(f.query);h.nid=b,d&&(h.partner=d),a.io({url:g,data:h,type:"GET",dataType:"jsonp",success:function(a){c(a)},error:e||function(){a.log("\u5230\u624b\u4ef7\u8bf7\u6c42\u5931\u8d25")}})},purchaseDecisionBatch:function(b,c,d,e){var f=window.purchase_decision,g=f.batch_purchase_decision_url,h=a.clone(f.query);h.items=b,d&&(h.partner=d),a.io({url:g,data:h,type:"GET",dataType:"jsonp",success:function(a){c(a)},error:e||function(){a.log("\u6279\u91cf\u5230\u624b\u4ef7\u8bf7\u6c42\u5931\u8d25")}})},purchaseDetail:function(b,c,d,e,f){var g=window.purchase_decision,h=g.purchase_detail_url,i=a.clone(g.query);i.nid=b,d&&(i.partner=d),e&&(i.skuProperties=e),f&&(i.dpp=f),a.io({url:h,data:i,type:"GET",dataType:"jsonp",success:function(a){c(a)},error:function(){a.log("\u5230\u624b\u4ef7\u8bf7\u6c42\u5931\u8d25")}})},createOkDlgInfo:function(b,c,d){var e,f="";if(a.Cookie.get("_tb_token_")&&(f=a.Cookie.get("_tb_token_")),c){e=b.allPlans[d];var g=e.finalPrice;g-Math.floor(g)>0&&(g=g.toFixed(2));var h={total:e.totalSaving,"final":g,link:e.etaoShopLink,price:b.auction.currentPrice},i=b.auction.sellerId}else{e=b;var g=e.finalPrice;g-Math.floor(g)>0&&(g=g.toFixed(2));var h={total:e.totalSaving,"final":g,link:e.etaoShopLink,price:parseFloat(e.currentPrice)},i=b.sellerId}if(0!=e.promotionSaving){var j;j=e.promotionDescription?e.promotionDescription:1==e.promotionType?"\u6ee1"+e.promotionThreshold+"\u51cf"+e.promotionSaving+"\u5143":"\u51cf"+e.promotionSaving+"\u5143",h.activity={desc:j,saving:parseFloat(e.promotionSaving)}}if(e.quanId>0){var k,l=e.quanTitle;l||(l=1==e.quanType?"\u6ee1"+e.quanThreshold+"\u51cf"+e.quanSaving+"\u5143":"\u51cf"+e.quanSaving+"\u5143"),e.quanPrice>0?(l+=0==e.quanPriceType?"\uff08\u9700\u8981\u6d88\u8017"+e.quanPrice+"\u4e2a\u96c6\u5206\u5b9d\uff09":"\uff08\u9700\u8981"+e.quanPrice+"\u4e2a\u5929\u732b\u79ef\u5206\uff09",coseDesc=e.quanPriceDescription||""):(k="",e.quanThreshold>e.currentPrice&&(l+="\uff08\u9700\u51d1\u5355\uff09"));var m="http://quan.etao.com/ajax/claim.htm?id="+e.quanId+"&source="+e.quanSource+"&sid="+i+"&_tb_token_="+f+"&channel='etaodetailquan'";h.coupon={admix:parseFloat(e.quanValue),full_cut:parseFloat(e.quanThreshold),api:m,cost:parseInt(e.quanPrice),cost_desc:k,saving:parseFloat(e.quanSaving),source:e.quanSource,title:l}}var n=e.rebateSaving-e.newUserExtraRebate;if(0!=n){var o;o=e.vipLevelOneRebate==e.currentVipRebate?"\u7ea6\u9001"+e.currentVipRebate+"\u4e2a":'\u7ea6\u9001<span class="del">'+e.vipLevelOneRebate+"\u4e2a</span> "+e.currentVipRebate+"\u4e2a",o+=e.vipLevel<2?"\uff08\u5347\u7ea7\u5230v2\u540e\u53ef\u591a\u90015%\uff09":"\uff08V"+e.vipLevel+"\u4f1a\u5458\u9001"+e.vipExtraScale+"\u4e2a\uff09",h.rebate={desc:o,saving:parseFloat(n.toFixed(2))/100},void 0===window.rebateSpeed&&"s.etao.com"==location.host&&a.io({url:"/auction_detail/async_suda.php",type:"GET",dataType:"json",cache:!1,async:!1,success:function(a){a.status&&a.result&&(window.rebateSpeed=a.result)},error:function(b){a.log(b)}}),1==window.rebateSpeed?h.rebate.level={speed:"top-speed",caption:"<span>\u6781\u901f\u8fbe</span>\u63d0\u4ea4\u8ba2\u5355\u540e\u5373\u53ef\u5230\u5e10"}:2==window.rebateSpeed&&(h.rebate.level={speed:"high-speed",caption:"<span>\u5feb\u901f\u8fbe</span>\u786e\u8ba4\u6536\u8d27\u540e\u5373\u53ef\u5230\u5e10"}),e.nocpsRebate&&(h.present={tip:"\uff08\u6bcf\u4eba\u6bcf\u65e5\u9650\u90015\u5355\uff09"})}return e.newUserExtraRebate>0,h},showDlgByDlgInfo:function(a,b){var c=window.okDialog;c?(c.set("stat",b),c.popup(a)):(KISSY.use("ok-dialog",function(a,b){c=new b({stat:{order:"order",close:"close"},priceTmpl:'<span class="purchase-price"></span>',autoHide:!0})}),window.okDialog=c,c.set("stat",b),c.popup(a))},showDlgByDiscountInfo:function(a,b){var c=this;c.showDlgByDlgInfo(c.createOkDlgInfo(a,!1,0),b)}};return b},{requires:[]});