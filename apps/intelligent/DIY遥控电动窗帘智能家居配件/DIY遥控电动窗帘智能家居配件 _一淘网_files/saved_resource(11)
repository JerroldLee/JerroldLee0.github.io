KISSY.add("components/comment/index",function(a,b,c,d,e,f){function g(a){var b=this;g.superclass.constructor.call(b,a),b._init()}var h=b.all,i=a.DOM,j="taobao",k=window.clickStat+"&lf_aclog=null-null-null-null-0&stats_click=detail_comm%3A";return a.extend(g,c,{_init:function(){var a=this;a._initParam(),a._bind(),a._fetch(a._page(1),!1)},_initParam:function(){var a,b,c,d,e=this,f=e.get("el");a=f.attr("source"),b=f.attr("data-url"),c=f.attr("data-api"),d=e.get(a===j?"hasPhotoTmpl":"noPhotoTmpl"),e.set("source",f.attr("source")),e.set("url",f.attr("data-url")),e.set("api",f.attr("data-api")),e.set("tmpl",d)},_bind:function(){{var b=this;b.get("source")}b.on("afterTotalPageChange",a.bind(b._initPagination,b))},_initPagination:function(){var b,c=this,d=(c.source,c.get("totalPage")),f=c.get("currentPage"),g=c.get("paginator");b={currentPage:f,totalPage:d,lastPagesCount:1},g&&g.detach("switch"),g=new e("#J_pagination",b),c.set("paginator",g),a.one("#J_pagination").all("a").each(function(b){a.one(b).attr("data-stat",k+"page")}),g.on("switch",function(a){a.preventDefault(),c._fetch(c._page(a.toPage),!0)})},_fetch:function(c,d){var e=this,g=e.get("el"),h=e.get("source"),j=e.get("url");a.io({dataType:"jsonp",scriptCharset:"gbk",url:c,jsonp:"callback",success:function(c){if(c=e._parse(c,h),0===c.comments.length){var l="";return a.one(".recommend")&&(l="nocnt-bor"),void g.html('<div class="user-comment-nocnt '+l+'"><p><a target="_blank" href="'+j+'" data-stat="'+k+'click_unknow"><img src="http://gtms02.alicdn.com/tps/i2/T1ntmfFB0cXXbMMwZ5-129-129.png" border="0"></a></p><p>\u4eb2\uff0c\u76f4\u63a5\u5230\u5546\u5bb6<a target="_blank" href="'+j+'" data-stat="'+k+'click_unknow">\u67e5\u770b\u8bc4\u4ef7</a>\u5427</p><p>\u770b\u5b8c\u8bc4\u4ef7\uff0c\u8bb0\u5f97\u56de\u6765\u4f18\u60e0\u8d2d\u4e70\uff0c\u624d\u80fd\u62ff\u5230\u4f18\u60e0\u54e6\uff01</p></div>')}b.one("#J_commentList").html(new f(e.get("tmpl")).render({comments:c.comments})),d&&i.scrollTop(g.offset().top-50),e.set("currentPage",c.currentPage),e.set("totalPage",c.totalPage)},error:function(){g.html("<p>\u83b7\u53d6\u70b9\u8bc4\u5185\u5bb9\u51fa\u9519\uff0c\u8bf7\u5237\u65b0\u540e\u91cd\u8bd5</p>")},data:{t:(new Date).getTime()+Math.ceil(1e3*Math.random())}})},_page:function(a){var b,c=this,e=c.get("source"),f=c.get("api"),g=new d(f);return b=e===j?g.getQuery().set("currentPageNum",a).toString():g.getQuery().set("currentPage",a).toString(),g.setQuery(b).toString()},_parse:function(a,b){var c,d,e,f,g,h=[],i=/<br\s*\/?>/g,j=/&nbsp;?/g;try{switch(b){case"taobao":for(c=a.currentPageNum,d=a.maxPage,e=0,f=a.comments.length;f>e;e++)g=a.comments[e],h.push({nick:g.user.nick,anony:g.user.anony,avatar:g.user.avatar,content:g.content.replace(i,""),date:g.date,sku:g.auction.sku.replace(j,"")});break;case"tmall":for(a=a.rateDetail,c=a.paginator.page,d=a.paginator.lastPage,e=0,f=a.rateList.length;f>e;e++)g=a.rateList[e],h.push({nick:g.displayUserNick,anony:g.anony,content:g.rateContent,date:g.rateDate,sku:g.auctionSku});break;default:for(a=a.rateDetail,c=a.paginator.page,d=a.paginator.lastPage,e=0,f=a.rateList.length;f>e;e++)g=a.rateList[e],h.push({nick:g.displayUserNick||"",sku:g.auctionSku||"",content:g.rateContent,date:g.rateDate})}}catch(k){c=1,d=0,h.length=0}return{currentPage:c,totalPage:d,comments:h}}},{ATTRS:{el:{value:h(".comment")},source:{value:""},url:{value:"#"},api:{value:""},currentPage:{value:1,setter:function(b){return a.isNumber(b)?b:parseInt(b)}},totalPage:{value:0,validator:function(a){var b=this.get("totalPage");return a=parseInt(a),b>=a?!1:void 0}},paginator:{value:null},tmpl:{value:""},hasPhotoTmpl:{value:['<ul class="comment-list">',"{{#comments}}",'    <li class="comment-list-item clearfix">','        <div class="comment-user">','            <p class="comment-avatar"><img src="{{avatar}}"></p>','            <p class="comment-name">{{nick}}{{#anony}}(\u533f\u540d){{/anony}}</p>',"        </div>",'        <div class="comment-main">','            <p class="comment-content">{{content}}</p>','            <p class="comment-info">[{{date}}] {{#sku}}{{sku}}{{/sku}}</p>',"        </div>","    </li>","{{/comments}}","</ul>"].join("")},noPhotoTmpl:{value:['<ul class="comment-list">',"{{#comments}}",'    <li class="comment-list-item clearfix">','        <div class="comment-main">','            <p class="comment-content">{{content}}</p>','            <p class="comment-info"><span class="comment-name">{{nick}}</span> \u53d1\u8868\u4e8e {{date}}</p>',"        </div>","    </li>","{{/comments}}","</ul>"].join("")}}}),g},{requires:["node","base","uri","gallery/pagination/2.0/index","xtemplate","./index.css"]});